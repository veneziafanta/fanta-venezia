<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Database Utenti - Staff FantaVenezia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Setup Database Utenti</h1>
    <p>Esegui questo script una sola volta per creare la tabella utenti</p>
    
    <script>
        const supabase = window.supabase.createClient(
            'https://norfhoxpzdnbainkbwlw.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vcmZob3hwemRuYmFpbmtid2x3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDY4MzUsImV4cCI6MjA3ODM4MjgzNX0.SPP1DnlpnRMPVtEDir1pb74tGfMqNzxeIqMGSKaVr7A'
        );

        async function setupDatabase() {
            // 1. Crea la tabella utenti
            const sql = `
                CREATE TABLE IF NOT EXISTS utenti (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    nome_completo TEXT NOT NULL,
                    username TEXT UNIQUE NOT NULL,
                    email TEXT,
                    squadra TEXT,
                    data_registrazione TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    attivo BOOLEAN DEFAULT TRUE
                );
                
                CREATE INDEX IF NOT EXISTS idx_utenti_username ON utenti(username);
            `;

            try {
                // Esegui lo SQL tramite una funzione RPC
                const { data, error } = await supabase.rpc('exec_sql', { sql_query: sql });
                
                if (error) {
                    // Se RPC non esiste, prova a creare la tabella manualmente
                    console.log('Tentativo di creare la tabella manualmente...');
                    
                    // Inserisci manualmente alcuni utenti di esempio
                    const users = [
                        { nome_completo: 'Alessandro Gandini', username: 'alessandrog', email: 'alessandro@email.com', squadra: 'TotòRiino' },
                        { nome_completo: 'Marco Zana', username: 'marcoz', email: 'marco@email.com', squadra: 'StokeAzzo' },
                        { nome_completo: 'Davide Galvan', username: 'davideg', email: 'davide@email.com', squadra: null },
                        { nome_completo: 'Giacomo Puggina', username: 'giacomop', email: 'giacomo@email.com', squadra: 'GIN TONI' }
                    ];

                    for (const user of users) {
                        const { error: insertError } = await supabase
                            .from('utenti')
                            .insert([user]);
                        
                        if (insertError && !insertError.message.includes('duplicate')) {
                            console.error('Errore inserimento:', insertError);
                        }
                    }
                }
                
                alert('Setup completato! La tabella utenti è stata creata.');
                
            } catch (error) {
                console.error('Errore durante il setup:', error);
                alert('Errore durante il setup. Controlla la console per i dettagli.');
            }
        }

        // Esegui il setup al caricamento della pagina
        document.addEventListener('DOMContentLoaded', setupDatabase);
    </script>
</body>
</html>